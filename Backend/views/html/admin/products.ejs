<!DOCTYPE html>
<html lang="en">

<%- include("../../templates/head.ejs" , {title: 'Products' }) %>


    <body class="bg-gradient-to-b from-pink-400 via-white to-gray-700 bg-no-repeat" style="scrollbar-width: none;">

        <%- include("../../templates/header.ejs") %>

            <main class="relative flex flex-col lg:flex-row lg:p-5 py-5 w-full">
                <div id="msg" class="absolute px-3 py-2 rounded-lg right-0 text-white" style="z-index: 1000;">
                </div>
                <section class="w-full lg:w-1/5 px-5 py-5 border-r-2 border-pink-500">
                    <%- include("../../templates/dashboardSidebar.ejs" , {selected: 'products' }) %>
                </section>
                <section class=" relative flex flex-col w-full px-5 pt-8 overflow-x-scroll">
                    <div id="sortDiv" class="absolute flex flex-col items-center justify-center w-full h-auto hidden">
                        <div class="flex flex-col w-full lg:w-1/3 bg-black px-10 py-5 h-auto ">
                            <div class="relative">
                                <button class="absolute right-0 mx-5" onclick="sortButton()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="white" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-x">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>

                            <div class="text-white font-bold text-xl w-full text-center">Filter</div>
                            <label class="text-white" for="ctg">Select category</label>
                            <select name="ctg" id="ctg" class="w-full p-3 my-2">
                                <option value="all" selected class="bg-gray-300">
                                    All
                                </option>
                                <%for(let i=0 ;i< categories.length; i++){%>
                                    <option class=" bg-gray-300" value="<%= categories[i].name %>">
                                        <%= categories[i].name.toUpperCase()%>
                                    </option>
                                    <%} %>
                            </select>
                            <a class="bg-gray-300 rounded-lg px-3 py-2 w-fit " id="sortFetchButton" href="#">
                                Submit
                            </a>
                            <script>
                                let ctg = document.querySelector('#ctg')
                                let sortAnchor = document.querySelector('#sortFetchButton')
                                let id = JSON.parse(localStorage.getItem('halls-user')).id
                                sortAnchor.href = `/admin/products?id=${id}&ctg=all`
                                ctg.addEventListener('change', (e) => {
                                    sortAnchor.href = `/admin/products?id=${id}&ctg=${ctg.value}`
                                })
                            </script>
                        </div>
                    </div>

                    <div id="productAddDiv" class="absolute flex flex-col items-center justify-center w-full hidden">

                        <div class="w-full lg:w-1/3 bg-black text-white px-10 py-5">
                            <style>
                                label {
                                    padding-bottom: 10px;
                                }

                                #productAddUl>li>input {
                                    padding: 2px;
                                    color: gray;
                                }
                            </style>
                            <div class="relative">
                                <button class="absolute right-0 mx-5" onclick="addProductButton()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-x">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>

                            <ul id="productAddUl">
                                <li class="py-2 flex flex-col">
                                    <p class="text-lg font-bold text-pink-600">Add Product</p>
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="name">Name<span class="text-red-700">*</span></label>
                                    <input type="text" required name="name" id="name" placeholder="Product Name">
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="discription">Discription<span class="text-red-700">*</span></label>
                                    <input type="text" required name="discription" id="discription"
                                        placeholder="About the item">
                                </li>
                                <li class="py-2 flex flex-col ">
                                    <label for="category">Category</label>
                                    <select class="text-gray-500" id="category" name="category"
                                        onclick="fetchCategory(); this.onclick=null;">
                                        <option>Select</option>
                                    </select>
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="price">Price<span class="text-red-700">*</span></label>
                                    <input type="number" min="0" required name="price" id="price"
                                        placeholder="Product Price">
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="stock_units">Stock<span class="text-red-700">*</span></label>
                                    <input type="number" min="0" required name="stock_units" id="stock_units"
                                        placeholder="Count in stock">
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="images">Images<span class="text-red-700">*</span>
                                        <p class="font-normal text-xs text-red-400">please upload fresh image</p>
                                    </label>

                                    <input type="file" accept="image/png , image/jpeg" required name="images"
                                        id="images" placeholder="Count in stock">
                                </li>
                                <li class="py-2 flex flex-col ">
                                    <label for="outletId">Outlet</label>
                                    <select class="text-gray-500" id="outletId" name="outletId"
                                        onclick="fetchOutlets(); this.onclick=null;">
                                        <option>Select</option>
                                    </select>
                                </li>
                                <li class="py-2 flex flex-col">
                                    <label for="discount">Discount(optional)</label>
                                    <input type="number" value="0" name="discount" id="discount"
                                        placeholder="Discount in Percentage">
                                </li>
                                <li class="py-2 flex flex-col">
                                    <button class="py-2 cursor-pointer bg-gray-600 rounded hover:bg-gray-700"
                                        id="productAddFormButton">Submit</button>
                                </li>
                            </ul>
                        </div>
                        <script>
                            let aid = JSON.parse(localStorage.getItem('halls-user')).id
                            async function fetchCategory() {
                                let category = document.querySelector('#category')
                                category.innerHTML = ''
                                let res = await fetch(`/admin/products/fetchcategory?id=${aid}`).then(res => res.json())
                                if (res.status == 200) {
                                    for (let i = 0; i < res.categories.length; i++) {
                                        let opt = document.createElement('option')
                                        opt.innerText = res.categories[i].name
                                        opt.value = res.categories[i].id
                                        category.appendChild(opt)
                                    }
                                } else {
                                    alert("error in process")
                                }
                            }

                            async function fetchOutlets() {
                                let outlets = document.querySelector('#outletId')
                                outlets.innerHTML = ''
                                let res = await fetch(`/admin/products/fetchOutlets?id=${aid}`).then(res => res.json())
                                if (res.status == 200) {
                                    for (let i = 0; i < res.outlets.length; i++) {
                                        let opt = document.createElement('option')
                                        opt.innerText = res.outlets[i].name
                                        opt.value = res.outlets[i].id
                                        outlets.appendChild(opt)
                                    }
                                } else {
                                    alert("error in process")
                                }
                            }

                            let form = document.querySelector('#productAddFormButton')
                            form.addEventListener('click', addProduct)
                            async function addProduct() {
                                let name = document.querySelector('#name')
                                let discription = document.querySelector('#discription')
                                let category = document.querySelector('#category')
                                let stock_units = document.querySelector('#stock_units')
                                let price = document.querySelector('#price')
                                let discount = document.querySelector('#discount')
                                let images = document.querySelector('#images')
                                let outletId = document.querySelector('#outletId')

                                let data = new FormData()
                                data.append('name', name.value)
                                data.append('discription', discription.value)
                                data.append('categoryId', category.value)
                                data.append('stock_units', stock_units.value)
                                data.append('price', price.value)
                                data.append('discount', discount.value)
                                data.append('outletId', outletId.value)
                                data.append('images', images.files[0])

                                if (name && discription && category && stock_units && price && images.files.length > 0 && outletId) {
                                    form.innerHTML = 'loading...'
                                    let res = await fetch(`/admin/products/add?id=${aid}`, { method: 'post', body: data }).then(res => res.json())
                                    let msg = document.querySelector('#msg')
                                    if (res.status == 200) {
                                        msg.innerText = res.message
                                        msg.style.background = 'green'
                                        

                                        // name.value = "", discription.value = "", stock_units.value = 0, price.value = 0, discount.value = 0
                                        addProductButton()
                                        window.location.reload()
                                        form.innerHTML = 'Submit'

                                    } else {
                                        msg.innerText = res.message
                                        msg.style.background = 'red'
                                    }
                                    setTimeout(() => {
                                        msg.innerHTML = ''
                                        msg.style.background = 'transparent'
                                    }, 5000)
                                } else {
                                    alert('fill details properly')
                                }
                            }
                        </script>
                    </div>
                    <div>
                        <ul class="flex text-white font-bold">
                            <li class="flex bg-pink-500 p-2 px-3 rounded-lg h-fit hover:bg-pink-400">
                                <button class="flex px-1 focus:outline-none" onclick="addProductButton()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-plus">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Product
                                </button>
                            </li>
                            <li class="flex bg-pink-500 p-2 px-3 rounded-lg h-fit hover:bg-pink-400 mx-2">
                                <button class="flex px-1 focus:outline-none" onclick="sortButton()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-filter">
                                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                    </svg>
                                    Filter
                                </button>
                            </li>
                        </ul>
                        <script>
                            function addProductButton() {
                                let div = document.querySelector("#productAddDiv")
                                div.classList.toggle('hidden')
                            }
                            function sortButton() {
                                let div = document.querySelector("#sortDiv")
                                div.classList.toggle('hidden')
                            }
                        </script>
                    </div>
                    <div class="absolute flex items-center justify-center right-0">
                        <p id="status" class="px-3 py-2 rounded hidden">

                        </p>
                    </div>
                    <div class='py-5 w-full '>
                        <% if(products.length> 0){ %>
                            <table class="table-auto overflow-scroll w-full">
                                <thead class="border-b bg-pink-600">
                                    <tr>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Name
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Category
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Price
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Stock
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Discount
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Rating
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Created By
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Created on
                                        </th>
                                        <th scope="col" class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                            Delete
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <% for(let i=0 ; i< products.length; i++){%>
                                        <tr class="border-b bg-white">
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <%= products[i].name %>
                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <%= products[i].category%>
                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <%= products[i].price %>â‚¹
                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <%= products[i].stock_units %>
                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <span
                                                    class="bg-<%= products[i].discount<5?'red':products[i].discount<=20?'yellow':'green'%>-600 text-white font-bold px-2 py-1 rounded-xl">
                                                    <%= products[i].discount %>%
                                                </span>
                                            </td>
                                            <td
                                                class="flex text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <% for(let j=0 ; j < products[i].rating; j++ ){ %>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                        viewBox="0 0 24 24" fill="#ff6700" stroke="currentColor"
                                                        stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                                                        class="feather feather-star">
                                                        <polygon
                                                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                                        </polygon>
                                                    </svg>
                                                    <% } %>
                                                        <% for(let k=products[i].rating ; k < 5; k++ ){ %>
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                                                height="14" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="1"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="feather feather-star">
                                                                <polygon
                                                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                                                </polygon>
                                                            </svg>
                                                            <% } %>

                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <%= products[i].first_name+" "+products[i].last_name %>
                                        </td>
                                        <td
                                            class=" text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                    <%= products[i].createdOn.toString().split('GMT')[0] %>
                                            </td>
                                            <td class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                <button onclick="deleteProduct(this)" data-id="<%= products[i].id %>">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2"
                                                        stroke-linecap="round" stroke-linejoin="round"
                                                        class="feather feather-trash-2">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path
                                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                        </path>
                                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                        <%}%>
                                </tbody>
                            </table>

                            <%}else{%>

                                <div class="flex items-center justify-center px-5 py-3 bg-red-500 text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-frown">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                    </svg>
                                    <span class="px-2">
                                        No Products exits
                                    </span>
                                </div>
                                <%}%>
                </section>

            </main>
            <%- include("../../templates/footer.ejs") %>
    </body>
    <script>
        async function deleteProduct(ele) {
            let cnf = confirm('Are you sure?')
            if (cnf) {
                let id = ele.getAttribute('data-id')
                let userId = JSON.parse(localStorage.getItem('halls-user')).id
                let res = await fetch(`/admin/products/${id ?? null}/delete/${userId}`).then(r => r.json())
                let status = document.querySelector('#status')
                status.classList.add = 'block'
                if (res.code == 200) {
                    status.style.background = 'green'
                    status.innerText = 'Error : Product Deleted'
                    window.location.reload()
                } else {
                    status.style.background = 'red'
                    status.innerText = 'Error :' + res.status
                    alert('Something went wrong? try again')
                }
                setTimeout(() => {
                    status.classList.add = 'hidden'
                    status.classList = 'hidden'
                }, [1000])
            }

        }
    </script>

</html>